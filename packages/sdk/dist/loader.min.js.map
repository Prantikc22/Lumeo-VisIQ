{"version":3,"sources":["../src/loader.ts"],"sourcesContent":["// packages/sdk/src/loader.ts\n(function () {\n    \"use strict\";\n    var w = window as any, d = document;\n    var s = d.currentScript as HTMLScriptElement;\n  \n    // required from customer\n    var SITE_KEY = s?.getAttribute(\"data-sitekey\") || \"\";\n  \n    // ✅ default API base: data-attr → same-origin /api (good for customers) → last-resort localhost\n    var API_BASE = (\n        s?.getAttribute(\"data-api-base\") || \"https://lumeovisiq.com/api\"\n      ).replace(/\\/+$/, \"\");\n      \n  \n    if (!SITE_KEY) { console.warn(\"[VisitorIQ] Missing data-sitekey on loader <script>\"); return; }\n  \n    // compute base URL to load index.min.js from same package/version as loader\n    function baseFromScript(src: string) {\n      try { const u = new URL(src); u.pathname = u.pathname.replace(/[^/]+$/, \"\"); return u.origin + u.pathname; }\n      catch { return \"\"; }\n    }\n    var LOADER_BASE = baseFromScript((s && s.src) || \"\");\n    var INDEX_SRC = LOADER_BASE + \"index.min.js\";\n    var TM_SRC = \"https://cdn.jsdelivr.net/npm/@thumbmarkjs/thumbmarkjs/dist/thumbmark.umd.js\";\n    var BOTD_SRC = \"https://openfpcdn.io/botd/v1\";\n  \n    // ✅ allow opting into CORS only when needed\n    function loadScript(src: string, useCors = false) {\n      return new Promise<void>(function (resolve, reject) {\n        var el = d.createElement(\"script\");\n        el.src = src;\n        el.async = true;\n        if (useCors) el.crossOrigin = \"anonymous\"; // <-- only when true\n        el.onload = function(){ resolve(); };\n        el.onerror = function(){ reject(new Error(\"load error: \" + src)); };\n        d.head.appendChild(el);\n      });\n    }\n  \n    function overlayBlock(msg?: string) {\n      var o = d.createElement(\"div\");\n      o.style.cssText = \"position:fixed;inset:0;z-index:2147483647;background:#0b0b0be6;color:#fff;display:flex;align-items:center;justify-content:center;padding:24px;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:18px;text-align:center;\";\n      o.textContent = msg || \"Access denied: Your device is blocked.\";\n      d.documentElement.appendChild(o);\n      d.documentElement.style.overflow = \"hidden\";\n    }\n  \n    function getThumbmark() {\n      if (w.ThumbmarkJS && w.ThumbmarkJS.Thumbmark) {\n        try { return new w.ThumbmarkJS.Thumbmark().get(); } catch { /* noop */ }\n      }\n      // ✅ third‑party CDN → CORS ok\n      return loadScript(TM_SRC, true).then(function () {\n        try { return new w.ThumbmarkJS.Thumbmark().get(); } catch { return { thumbmark: \"\" }; }\n      });\n    }\n  \n    function checkBlocked(fp: string) {\n      var url = API_BASE + \"/blocks?siteKey=\" + encodeURIComponent(SITE_KEY) + \"&fp=\" + encodeURIComponent(fp || \"\");\n      return fetch(url, { method: \"GET\", mode: \"cors\", headers: { \"x-usage-track\": \"true\" } })\n        .then(function (r) { return r.ok ? r.json() : null; })\n        .then(function (data) {\n          if (!data) return false;\n          if (typeof data.blocked === \"boolean\") return data.blocked;\n          if (Array.isArray(data.blocks)) return !!data.blocks.some(function (b: any) { return b && b.value === fp; });\n          return false;\n        })\n        .catch(function () { return false; });\n    }\n  \n    function getBotd() {\n      if (w.Botd) { try { return w.Botd.load().then((b: any) => b.detect()); } catch { return Promise.resolve(null); } }\n      // ✅ third‑party CDN → CORS ok\n      return loadScript(BOTD_SRC, true)\n        .then(function () { try { return w.Botd.load().then((b: any) => b.detect()); } catch { return null; } })\n        .catch(function () { return null; });\n    }\n  \n    function start() {\n      Promise.resolve()\n        .then(getThumbmark)\n        .then(function (tm: any) {\n          var fp = (tm && tm.thumbmark) || \"\";\n          return checkBlocked(fp).then(function (blocked) {\n            if (blocked) { overlayBlock(\"Access denied: Your device is blocked.\"); return null; }\n            return getBotd().then(function (botd: any) { return { botd: botd }; });\n          });\n        })\n        .then(function (ctx: any) {\n          if (!ctx) return; // blocked\n          // ✅ YOUR SDK: do NOT force CORS here\n          return loadScript(INDEX_SRC, false).then(function () {\n            if (w.visitoriq && typeof w.visitoriq.init === \"function\") {\n              w.visitoriq.init({\n                siteKey: SITE_KEY,\n                endpoint: API_BASE + \"/collect-visitor\",\n                botd_result: ctx.botd\n              });\n            } else {\n              console.warn(\"[VisitorIQ] visitoriq.init missing. Check index.min.js path:\", INDEX_SRC);\n            }\n          });\n        })\n        .catch(function () { /* swallow non-fatal */ });\n    }\n  \n    if (d.readyState === \"loading\") d.addEventListener(\"DOMContentLoaded\", start); else start();\n  })();\n  "],"mappings":"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","names":["w","d","s","SITE_KEY","API_BASE","baseFromScript","src","u","LOADER_BASE","INDEX_SRC","TM_SRC","BOTD_SRC","loadScript","useCors","resolve","reject","el","overlayBlock","msg","o","getThumbmark","checkBlocked","fp","url","r","data","b","getBotd","start","tm","blocked","botd","ctx"]}